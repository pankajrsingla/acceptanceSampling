#
# Copyright (C) 2018 University of Amsterdam
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
#

# txt = "Analyze single stage and multiple stage attribute plans"
# banner(txt, centre = TRUE, bandChar = "-")
##---------------------------------------------------------------
##   Analyze single stage and multiple stage attribute plans   --
##---------------------------------------------------------------
#' @param jaspResults <>
#' @param dataset <>
#' @param options <>
#' @seealso
#'   [getOCCurve()] for operating characteristics of the plan.
#' @examples
#' AnalyzeAttributePlan(jaspResults, dataset, options)
##---------------------------------------------------------------
AnalyzeAttributePlan <- function(jaspResults, dataset = NULL, options, ...) {
  plan_vars <- c("lotSize", "distribution")
  pd_vars <- c("pd_lower", "pd_upper", "pd_step")
  
  # Single sampling plan
  if ((options$sampleSizeSingle > 0) && (options$acceptNumberSingle >= 0)) {
    plan_vars_single <- c(plan_vars, "sampleSize", "acceptNumber", "rejectNumber")
    plan_vars_single <- paste0(plan_vars_single, "Single")
    pd_vars_single <- paste0(pd_vars, "Single")
    singleContainer <- createJaspContainer(title = "Single Sampling Plan")
    # Common dependencies for all single plans
    singleContainer$dependOn(c(plan_vars_single, pd_vars_single))
    jaspResults[["singleContainer"]] <- singleContainer
    .handleAttributePlan(singleContainer, position=0, plan_vars_single, pd_vars_single, options, "Single")
  }

  # Multiple sampling plan
  if (length(options$stages) > 1) {
    plan_vars_mult <- paste0(plan_vars, "Mult")
    plan_vars_mult <- c(plan_vars_mult, "stages")
    pd_vars_mult <- paste0(pd_vars, "Mult")
    multContainer <- createJaspContainer(title = "Multiple Sampling Plan")
    # Common dependencies for all multiple plans
    multContainer$dependOn(c(plan_vars_mult, pd_vars_mult))
    jaspResults[["multContainer"]] <- multContainer
    .handleAttributePlan(multContainer, position=100, plan_vars_mult, pd_vars_mult, options, "Mult")
  }
}

# txt = "Analyze attribute plans"
# banner(txt, centre = TRUE, bandChar = "-")
##---------------------------------------------------------------
##                   Analyze attribute plans                   --
##---------------------------------------------------------------
#' @param jaspContainer <>
#' @param position <>
#' @param plan_vars <>
#' @param pd_vars <>
#' @param options <>
#' @param type <>
#' @seealso
#'   [()] for <>
#' @examples
#' .handleAttributePlan(jaspContainer, position, plan_vars, pd_vars, options, type)
##---------------------------------------------------------------
.handleAttributePlan <- function(jaspContainer, position, plan_vars, pd_vars, options, type) {
  plan_table <- createJaspTable(title = "Acceptance Sampling Plan")
  if (type == "Single") {
    plan_table$dependOn(paste0(c("sampleSize", "acceptNumber", "rejectNumber"), type))
  } else {
    plan_table$dependOn(c("stages"))
  }
  plan_table$showSpecifiedColumnsOnly <- TRUE
  plan_table$position <- position
  jaspContainer[["plan_table"]] <- plan_table
  
  plan_values <- getPlanValues(jaspContainer, options, type)
  # Error handling for plan values
  if (jaspContainer$getError()) {
    return ()
  }

  # Error handling for hypergeometric distribution
  checkHypergeom(jaspContainer, pd_vars, options, type)
  if (jaspContainer$getError()) {
    return ()
  }
  
  n <- plan_values$n
  c <- plan_values$c
  r <- plan_values$r
  
  # Sampling plan table
  if (type == "Single") {
    # Single plan table
    plan_table$addColumnInfo(name = "table_1_col_1", title = "", type = "string")
    plan_table$addColumnInfo(name = "table_1_col_2", title = "Value", type = "integer")
    plan_table$addRows(list("table_1_col_1" = "Sample size", "table_1_col_2" = n))
    plan_table$addRows(list("table_1_col_1" = "Acceptance Number", "table_1_col_2" = c))
  } else {
    # Multiple plan table
    stages <- options[["stages"]]
    plan_table$addColumnInfo(name = "table_1_col_1", title = "Sample", type = "integer")
    plan_table$addColumnInfo(name = "table_1_col_2", title = "Sample Size", type = "integer")
    plan_table$addColumnInfo(name = "table_1_col_3", title = "Cum. Sample Size", type = "integer")
    plan_table$addColumnInfo(name = "table_1_col_4", title = "Acc. Number", type = "integer")
    plan_table$addColumnInfo(name = "table_1_col_5", title = "Rej. Number", type = "integer")
    plan_table$setData(list(table_1_col_1 = 1:length(stages), table_1_col_2 = n, table_1_col_3 = cumsum(n), 
                            table_1_col_4 = c, table_1_col_5 = r))
  }

  risk_vars <- paste0(c("pd_prp", "pa_prp", "pd_crp", "pa_crp"), type)
  output_vars <- paste0(c("assessPlan", "showSummary", "showOCCurve", "showAOQCurve", "showATICurve", "showASNCurve"), type)
  
  # Plan data
  plan <- getPlan(options, type, n, c, r)
  oc_plan <- plan$oc_plan
  df_plan <- na.omit(plan$df_plan)

  # Assess plan
  if (options[[output_vars[1]]]) {
    # Error handling for AQL/RQL => AQL < RQL, or pd_prp < pd_crp
    if (options[[risk_vars[1]]] >= options[[risk_vars[3]]]) {
      jaspContainer$setError(sprintf("Error: AQL (Acceptable Quality Level) value should be lower than RQL (Rejectable Quality Level) value."))
      return ()
    }
    # Error handling for Producer's and Consumer's Risk => 1 - α > β, or (1-pa_prp) > pa_crp
    if ((1 - options[[risk_vars[2]]]) <= options[[risk_vars[4]]]) {
      jaspContainer$setError(sprintf("Error: 1 - α (Producer's risk) has to be greater than β (consumer's risk)."))
      return ()
    }
    assessPlan(jaspContainer, pos=position+1, c(output_vars[1], risk_vars), oc_plan, options, type, n, c, r)
  }

  # Summary table
  if (options[[output_vars[2]]]) {
    getSummary(jaspContainer, pos=position+3, output_vars[2], df_plan)
  }

  # OC Curve
  if (options[[output_vars[3]]]) {
    getOCCurve(jaspContainer, pos=position+4, output_vars[3], df_plan)
  }

  # AOQ Curve (for plans with rectification)
  if (options[[output_vars[4]]]) {
    getAOQCurve(jaspContainer, pos=position+5, output_vars[4], df_plan, options, type, n, c, r)
  }

  # ATI Curve (for plans with rectification)
  if (options[[output_vars[5]]]) {
    getATICurve(jaspContainer, pos=position+6, output_vars[5], df_plan, options, type, n, c, r)
  }

  # ASN Curve (only for multiple sampling plan)
  if (options[[output_vars[6]]]) {
    getASNCurve(jaspContainer, pos=position+7, output_vars[6], options, n, c, r)
  }
}